import lambda_function
import json
import base64

def create_tables():
    print("Connecting to database to create tables if they don't exist...")
    try:
        conn = lambda_function.get_db_connection()
        cursor = conn.cursor()
        
        # 1. Clients Table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS clients (
                id SERIAL PRIMARY KEY,
                legal_name TEXT NOT NULL,
                doing_business_as TEXT,
                company_name TEXT NOT NULL,
                tax_id TEXT NOT NULL,
                industry TEXT,
                address TEXT,
                billing_address TEXT,
                payment_terms TEXT,
                timesheet_cadence TEXT,
                invoice_method TEXT,
                vms_portal_type TEXT,
                vms_portal_url TEXT,
                status TEXT DEFAULT 'New',
                is_active BOOLEAN DEFAULT TRUE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        """)
        
        # 2. Client Contacts Table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS client_contacts (
                id SERIAL PRIMARY KEY,
                client_id INTEGER REFERENCES clients(id) ON DELETE CASCADE,
                contact_type TEXT,
                name TEXT,
                email TEXT,
                phone TEXT,
                is_primary BOOLEAN DEFAULT FALSE,
                can_approve_timesheets BOOLEAN DEFAULT FALSE,
                can_approve_invoices BOOLEAN DEFAULT FALSE
            );
        """)
        
        # 3. Documents Table (Update)
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS documents (
                id SERIAL PRIMARY KEY,
                client_id INTEGER REFERENCES clients(id) ON DELETE SET NULL,
                file_path TEXT NOT NULL,
                bucket_name TEXT NOT NULL,
                uploaded_by TEXT,
                doc_type TEXT,
                description TEXT,
                uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        """)
        
        conn.commit()
        print("Tables created/verified successfully.")
        conn.close()
    except Exception as e:
        print(f"Error creating tables: {e}")

def test_create_client():
    print("\nTesting 'create_client' operation...")
    
    # This is the JSON provided by the user
    payload = {
        "operation": "create_client",
        "clientData": {
            "legalName": "F",
            "doingBusinessAs": "kldfj",
            "companyName": "lkjdskl",
            "taxId": "kjk",
            "industry": "lkjlkjlkj",
            "address": "kjhkj, klj, lkjlk, kjhk dddf",
            "billingAddress": "kjhkj, klj, lkjlk, kjhk dddf",
            "paymentTerms": "Net 30",
            "timesheetCadence": "Weekly",
            "invoiceMethod": "Email",
            "vmsPortalType": "Fieldglass",
            "vmsPortalUrl": "dszdzsdsd",
            "status": "New",
            "contacts": [
                {
                    "contactType": "General",
                    "name": "dfasdas",
                    "email": "sad",
                    "phone": "",
                    "isPrimary": True,
                    "canApproveTimesheets": True,
                    "canApproveInvoices": True
                }
            ],
            "isActive": True
        },
        "mpaFile": {
            "name": "new ER.png",
            "type": "image/png",
            "content": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAEOwAABEeCAYAAABA1qG3AAAQAElEQVR4AezdB5wdZbk4/uekEwIkQBCQFnoRFASx0K6ASNMLFwRBil3Qi6L+r4iKiori7yqKQETBS1cEAamiVEEk0nsnlEDoJKQQUv/7DMx6drOb7G52N7tzvnx4z7R33nmf75mdc7Iz77MDZs2aNU9h4BxwDjgHnAPOAeeAc8A54BxwDjgHnAPOAeeAc6D654D32HvsHHAOOAecA84B5wDzwDngHHAOOAecA86B6p8D3mPvsXOgH50DA8J/BAgQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQ6AkBCTt6QlWbBAgQIECAQNcF7EmAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBBpcQMKOBj8BhE+gUQTESYAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBAgQKC/CEjY0fV3yp4ECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBDoioCEHV1Rsw+BxSfgyAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVFxgQETFIxQeAQIECBAgQIAAAQIECBAgEBEQCBAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAgf4iMKC/dFQ/CRAgQIAAAQIECBDogwK6RIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIBAtwtI2NHtpBokQIAAAQIEFlXA/gQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAoJEFJOxo5Hdf7AQaS0C0BAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBPqFgIQdi/Q22ZkAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJBA7wpI2NG73o5GgAABAgQIECBAgACBNwW8EiBAgAABAgQIECBAgAABAtUXECEBAgQIECBAgAABAgQIECBQfQEREiBAgAABAgQIECBAgAABAtUXECEBAgQIEGhHQMKOdmCsJkCAAAECBAj0RwF9JkCAAAECBAgQIECAAAECBKovIEICBAgQIECAAAECBAgQIECg+gIiJECAAAECBAgQIECAAAECBKovIEICBAgQIECAAIH+LyBhR/9/D0VAgACBnhbQPgECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAQC8KSNjRi9gOVS9gngABAgQIECBAgAABAgQIEKi+gAgJECBAgAABAgQIECBAgACB6guIkAABAgQIECBAgAABAgQIEKi+gAgJECBAgAABAgQIECBAgACB6guIsCsCEnZ0Rc0+BAgQIECAAAECBAgQILD4BByZAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIFBxAQk7Kv4GC48AAQIECBAgQKBjAmoRIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECgrwhI2NFX3gn9IECAAIEqCoiJAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQINBpAQk7Ok1mBwKLW8DxCRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCossCbCTuqHKHYCBAgQIAAAQIECBAgQIAAgTcFvBIgQIAAAQIECBAgQIAAAQLVFxAhAQIECBAgQIAAAQIECBAgUH0BERIgQIAAAQIECBAgQIAAAQLVFxAhAQL9QkDCjn7xNukkAQIECBAgQIAAgb4roGcECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECHSvgIQd3eupNQIECBAgQKB7BLRCgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQaVkDCjoZ96wVOoBEFxEyAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECg7wtI2NHtpBokQIAAAQIEFlXA/gQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAoJEFJOxo5Hdf7AQaS0C0BAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBPqFgIQdi/Q22ZkAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJBA7wpI2NG73o5GgAABAgQIECBAgACBNwW8EiBAgAABAgQIECBAgAABAtUXECEBAgQIECBAgAABAgQIECBQfQEREiBAgAABAgQIECBAgAABAtUXECEBAgQIEGhHQMKOdmCsJkCAAAECBAj0RwF9JkCAAAECBAgQIECAAAECBKovIEICBAgQIECAAAECBAgQIECg+gIiJECAAAECBAgQIECAAAECBKovIEICBAgQIECAAIH+LyBhR/9/D0VAgACBnhbQPgECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAQC8KSNjRi9gOVS9gngABAgQIECBAgAABAgQIEKi+gAgJECBAgAABAgQIECBAgACB6guIkAABAgQIECBAgAABAgQIEKi+gAgJECBAgAABAgQIECBAgACB6guIsCsCEnZ0Rc0+BAgQIECAAAECBAgQILD4BByZAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIFBxAQk7Kv4GC48AAQIECBAgQKBjAmoRIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECgrwhI2NFX3gn9IECAAIEqCoiJAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQINBpAQk7Ok1mBwKLW8DxCRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCossCbCTuqHKHYCBAgQIAAAQIECBAgQIAAgTcFvBIgQIAAAQIECBAgQIAAAQLVFxAhAQIECBAgQIAAAQIECBAgUH0BERIgQIAAAQIECBAgQIAAAQLVFxAhAQL9QkDCjn7xNukkAQIECBAgQIAAgb4roGcECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECHSvgIQd3eupNQIECBAgQKB7BLRCgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQaVkDCjoZ96wVOoBEFxEyAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECg7wtI2NHtpBokQIAAAQIEFlXA/gQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAoJEFJOxo5Hdf7AQaS0C0BAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBPqFgIQdi/Q22ZkAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJBA7wpI2NG73o5GgAABAgQIECBAgACBNwW8EiBAgAABAgQIECBAgAABAtUXECEBAgQIECBAgAABAgQIECBQfQEREiBAgAABAgQIECBAgAABAtUXECEBAgQIEGhHQMKOdmCsJkCAAAECBAj0RwF9JkCAAAECBAgQIECAAAECBKovIEICBAgQIECAAAECBAgQIECg+gIiJECAAAECBAgQIECAAAECBKovIEICBAgQIECAAIH+LyBhR/9/D0VAgACBnhbQPgECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAQC8KSNjRi9gOVS9gngABAgQIECBAgAABAgQIEKi+gAgJECBAgAABAgQIECBAgACB6guIkAABAgQIECBAgAABAgQIEKi+gAgJECBAgAABAgQIECBAgACB6guIsCsCEnZ0Rc0+BAgQIECAAAECBAgQILD4BByZAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIFBxAQk7Kv4GC48AAQIECBAgQKBjAmoRIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECgrwhI2NFX3gn9IECAAIEqCoiJAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQINBpAQk7Ok1mBwKLW8DxCRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCossCbCTuqHKHYCBAgQIAAAQIECBAgQIAAgTcFvBIgQIAAAQIECBAgQIAAAQLVFxAhAQIECBAgQIAAAQIECBAgUH0BERIgQIAAAQIECBAgQIAAAQLVFxAhAQL9QkDCjn7xNukkAQIECBAgQIAAgb4roGcECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECHSvgIQd3eupNQIECBAgQKB7BLRCgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQaVkDCjoZ96wVOoBEFxEyAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECg7wtI2NHtpBokQIAAAQIEFlXA/gQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAoJEFJOxo5Hdf7AQaS0C0BAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBPqFgIQdi/Q22ZkAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJBA7wpI2NG73o5GgAABAgQIECBAgACBNwW8EiBAgAABAgQIECBAgAABAtUXECEBAgQIECBAgAABAgQIECBQfQEREiBAgAABAgQIECBAgAABAtUXECEBAgQIEGhHQMKOdmCsJkCAAAECBAj0RwF9JkCAAAECBAgQIECAAAECBKovIEICBAgQIECAAAECBAgQIECg+gIiJECAAAECBAgQIECAAAECBKovIEICBAgQIECAAIH+LyBhR/9/D0VAgACBnhbQPgECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAQC8KSNjRi9gOVS9gngABAgQIECBAgAABAgQIEKi+gAgJECBAgAABAgQIECBAgACB6guIkAABAgQIECBAgAABAgQIEKi+gAgJECBAgAABAgQIECBAgACB6guIsCsCEnZ0Rc0+BAgQIECAAAECBAgQILD4BByZAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIFBxAQk7Kv4GC48AAQIECBAgQKBjAmoRIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECAAAECBAgQIFB9ARESIECAAAECBAgQIECAAAEC1RcQIQECBAgQIECgrwhI2NFX3gn9IECAAIEqCoiJAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQIECAAIHqC4iQAAECBAgQIECAAAECBAgQqL6ACAkQIECAAAECBAgQINBpAQk7Ok1mBwKLW8DxCRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCovoAICRAgQIAAAQIECBAgQIAAgeoLiJAAAQIECBAgQIAAAQIECBCossCbCTuqHKHYCBAgQIAAAQIECBAgQIAAgTcFvBIgQIAAAQIECBAgQIAAAQLVFxAhAQIECBAgQIAAAQIECBAgUH0BERIgQIAAAQIECBAgQIAAAQLVFxAhAQL9QkDCjn7xNukkAQIECBAgQIAAgb4roGcECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECBAgQIAAAQIECFRfQIQECBAgQIAAAQIECBAgQIBA9QVESIAAAQIECHSvgIQd3eupNQIECBAgQKB7BLRCgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQIECBAgED1BURIgAABAgQIECBAgAABAgQIVF9AhAQIECBAgAABAgQaVkDCjoZ96wVOoBEFxEyAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECAQPUFREiAAAECBAgQIECAAAECBAhUX0CEBAgQIECAAAECBAgQIECg7wtI2NHtpBokQIAAAQIEFlXA//g"
        }
    }
    
    # Mock Context
    class MockContext:
        def __init__(self):
            self.function_name = "test_function"
            self.memory_limit_in_mb = 128
            self.invoked_function_arn = "arn:aws:lambda:local:123456789012:function:test"
            self.aws_request_id = "test-req-123"

    try:
        response = lambda_function.lambda_handler(payload, MockContext())
        print("Response received:")
        print(json.dumps(response, indent=2))
    except Exception as e:
        print(f"Test failed: {e}")

if __name__ == "__main__":
    create_tables()
    test_create_client()
